version: 1
applications:
  - appRoot: apps/api/
    backend:
      phases:
        preBuild:
          commands:
            - nvm install
            - nvm use
            - npm ci
        build:
          commands:
            # Build workspace packages
            - npx nx run-many --target=build --projects=models,webapp-shared --skip-nx-cache || true
        postBuild:
          commands:
            - mkdir -p apps/angular-demo/public/.well-known
            - cp apps/api/amplify_outputs.json apps/angular-demo/public/.well-known/amplify_outputs.json || echo "amplify_outputs.json not found yet"
    frontend:
      phases:
        preBuild:
          commands:
            - mkdir -p apps/angular-demo/public/.well-known
            - cp apps/api/amplify_outputs.json apps/angular-demo/public/.well-known/amplify_outputs.json || echo "amplify_outputs.json not found"
        build:
          commands:
            - npx nx build angular-demo --configuration=production
      artifacts:
        baseDirectory: dist/apps/angular-demo/browser
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .nx/cache/**/*
          - dist/packages/**/*
